@page "/login"
@using System.Net
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject ToastService ToastSvc
@using System.Net.Http.Json

<h3>Đăng nhập</h3>

<div class="card p-4 w-50">
    <div class="form-group mb-2">
        <label>Email</label>
        <input @bind="email" class="form-control" />
    </div>
    <div class="form-group mb-3">
        <label>Mật khẩu</label>
        <input type="password" @bind="password" class="form-control" />
    </div>
    <button class="btn btn-primary" @onclick="HandleLogin" disabled="@(isProcessing)">
        @if (isProcessing)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <span>Đang đăng nhập...</span>
        }
        else
        {
            <span>Đăng nhập</span>
        }
    </button>
    <p class="mt-3">Chưa có tài khoản? <a href="/register">Đăng ký</a></p>
</div>

@code {
    private string email = "";
    private string password = "";
    private bool isProcessing = false;

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            ToastSvc.ShowToast("Vui lòng nhập Email.", ToastLevel.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            ToastSvc.ShowToast("Vui lòng nhập Mật khẩu.", ToastLevel.Warning);
            return;
        }

        isProcessing = true;
        try
        {
            var client = HttpClientFactory.CreateClient("ServerAPI");
            var payload = new { email, password };
            var response = await client.PostAsJsonAsync("api/auth/login", payload);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TokenResponse>();

                if (!string.IsNullOrWhiteSpace(result?.token))
                {
                    await JS.InvokeVoidAsync("localStorage.setItem", "jwt", result.token);

                    if (AuthStateProvider is DoAnTotNghiep.Services.CustomAuthenticationStateProvider customProvider)
                    {
                        customProvider.NotifyUserAuthentication(result.token);
                    }

                    ToastSvc.ShowToast("Đăng nhập thành công.", ToastLevel.Success);

                    Navigation.NavigateTo("/", forceLoad: true);
                }
                else
                {
                    ToastSvc.ShowToast("Đăng nhập thất bại: máy chủ không trả về token.", ToastLevel.Error);
                }
            }
            else
            {
                if (response.StatusCode == HttpStatusCode.Unauthorized)
                {
                    ToastSvc.ShowToast("Email hoặc mật khẩu không đúng.", ToastLevel.Error);
                }
                else
                {
                    ToastSvc.ShowToast($"Đăng nhập thất bại. Mã lỗi: {(int)response.StatusCode}", ToastLevel.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("⚠️ Lỗi khi đăng nhập: " + ex);
            ToastSvc.ShowToast("Có lỗi xảy ra khi đăng nhập. Vui lòng thử lại.", ToastLevel.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    public class TokenResponse
    {
        public string token { get; set; }
        public DateTime expiration { get; set; }
    }
}
