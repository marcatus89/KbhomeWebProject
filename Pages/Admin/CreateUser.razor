@page "/admin/users/create"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<IdentityUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Navigation

<h3>T·∫°o Ng∆∞·ªùi d√πng m·ªõi</h3>

<EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @if (errorMessages.Any())
    {
        <div class="alert alert-danger">
            @foreach (var error in errorMessages)
            {
                <p>@error</p>
            }
        </div>
    }

    <div class="form-group mb-3">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="Model.Email" />
    </div>
    <div class="form-group mb-3">
        <label>M·∫≠t kh·∫©u</label>
        <InputText type="password" class="form-control" @bind-Value="Model.Password" />
    </div>
    <div class="form-group mb-3">
        <label>Ph√¢n quy·ªÅn</label>
        @foreach (var role in allRoles)
        {
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="@role.Id" value="@role.Name"
                       @onchange="(ChangeEventArgs e) => OnRoleChanged(role.Name, e)" />
                <label class="form-check-label" for="@role.Id">@role.Name</label>
            </div>
        }
    </div>

    <button type="submit" class="btn btn-primary">T·∫°o ng∆∞·ªùi d√πng</button>
    <a href="/admin/users" class="btn btn-secondary">H·ªßy</a>
</EditForm>

@code {
    private CreateUserModel Model { get; set; } = new();
    private List<IdentityRole> allRoles = new();
    private List<string> errorMessages = new();

    protected override async Task OnInitializedAsync()
    {
        allRoles = await RoleManager.Roles.ToListAsync();
    }

    private void OnRoleChanged(string roleName, ChangeEventArgs e)
    {
        bool isChecked = e.Value?.ToString()?.ToLower() == "true" || e.Value?.ToString() == "on";
        if (isChecked)
        {
            if (!Model.SelectedRoles.Contains(roleName))
                Model.SelectedRoles.Add(roleName);
        }
        else
        {
            Model.SelectedRoles.Remove(roleName);
        }
    }

    private async Task HandleValidSubmit()
    {
        errorMessages.Clear();

        if (string.IsNullOrWhiteSpace(Model.Email))
        {
            errorMessages.Add("‚ö†Ô∏è Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
            return;
        }

        // üîπ Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i ch∆∞a (kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng)
        var existingUser = await UserManager.Users
            .AsNoTracking()
            .FirstOrDefaultAsync(u => u.Email.ToLower() == Model.Email.ToLower());

        if (existingUser != null)
        {
            errorMessages.Add("‚ùå Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Vui l√≤ng ch·ªçn email kh√°c.");
            return;
        }

        var newUser = new IdentityUser
        {
            UserName = Model.Email,
            Email = Model.Email,
            EmailConfirmed = true
        };

        var result = await UserManager.CreateAsync(newUser, Model.Password);

        if (result.Succeeded)
        {
            if (Model.SelectedRoles.Any())
            {
                await UserManager.AddToRolesAsync(newUser, Model.SelectedRoles);
            }
            Navigation.NavigateTo("/admin/users");
        }
        else
        {
            foreach (var error in result.Errors)
            {
                errorMessages.Add(error.Description);
            }
        }
    }

    // üì¶ Model t·∫°m cho form
    public class CreateUserModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public List<string> SelectedRoles { get; set; } = new();
    }
}
