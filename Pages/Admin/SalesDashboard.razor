@page "/admin/sales"
@page "/admin/sales/page/{PageNumber:int}"
@attribute [Authorize(Roles = "Admin, Sales")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS

<h3 class="mb-3">
    <button class="btn btn-outline-secondary btn-sm me-3" @onclick="GoBack" title="Quay lại" aria-label="Quay lại">
        <i class="bi bi-arrow-left">Quay Lại</i>
    </button>
    Bảng điều khiển Kinh doanh (Sales)
</h3>

<div class="card">
    <div class="card-header">
        Các đơn hàng mới cần xác nhận
    </div>
    <div class="card-body">
        @if (pagedOrders == null)
        {
            <LoadingSpinner />
        }
        else if (!pagedOrders.Any())
        {
            <div class="alert alert-success mt-3">
                Tất cả các đơn hàng mới đã được xử lý!
            </div>
        }
        else
        {
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Mã Đơn hàng</th>
                        <th>Tên Khách hàng</th>
                        <th>Ngày đặt</th>
                        <th>Tổng tiền</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in pagedOrders)
                    {
                        <tr>
                            <td>#@order.Id</td>
                            <td>@order.CustomerName</td>
                            <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@order.TotalAmount.ToString("n0") VNĐ</td>
                            <td>
                                <a href="@($"/admin/orders/{order.Id}")" class="btn btn-sm btn-primary">Xem và Xác nhận</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- PHÂN TRANG (giống Product.razor) -->
            @if (totalPages > 1)
            {
                <nav class="mt-3" aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@($"/admin/sales/page/{Math.Max(currentPage - 1, 1)}")">Trước</a>
                        </li>

                        @for (int i = 1; i <= totalPages; i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                <a class="page-link" href="@($"/admin/sales/page/{pageNum}")">@pageNum</a>
                            </li>
                        }

                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <a class="page-link" href="@($"/admin/sales/page/{Math.Min(currentPage + 1, totalPages)}")">Sau</a>
                        </li>
                    </ul>
                </nav>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public int PageNumber { get; set; } = 1;

    private List<Order>? allOrders;
    private IEnumerable<Order>? pagedOrders;

    private int currentPage = 1;
    private int pageSize = 10; 
    private int totalPages = 1;

    protected override async Task OnParametersSetAsync()
    {
        currentPage = PageNumber > 0 ? PageNumber : 1;
        await LoadPendingOrders();
    }

    private async Task LoadPendingOrders()
    {
        IQueryable<Order> q = DbContext.Orders
            .AsNoTracking()
            .Where(o => o.Status == "Chờ xác nhận");

        allOrders = await q
            .OrderBy(o => o.OrderDate)
            .ToListAsync();

        totalPages = Math.Max(1, (int)Math.Ceiling((double)allOrders.Count / pageSize));
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        pagedOrders = allOrders
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task GoBack()
    {
        try
        {
            var handled = false;
            try
            {
                handled = await JS.InvokeAsync<bool>("appHelpers.goBackIfPossible");
            }
            catch
            {
                handled = false;
            }

            if (!handled)
            {
                Navigation.NavigateTo("/admin");
            }
        }
        catch
        {
            Navigation.NavigateTo("/admin");
        }
    }
}
