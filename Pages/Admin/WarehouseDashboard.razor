@page "/admin/warehouse"
@page "/admin/warehouse/page/{OrderPage:int}/{PoPage:int}/{RrPage:int}"
@page "/admin/warehouse/page/{OrderPage:int}/{PoPage:int}"
@attribute [Authorize(Roles = "Admin, Warehouse")]
@using Microsoft.EntityFrameworkCore
@using DoAnTotNghiep.Models
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <button class="btn btn-outline-secondary btn-sm" @onclick="GoBack" title="Quay lại">
            <i class="bi bi-arrow-left">Quay lại</i>
        </button>
        <h3 class="mb-0 ms-3">Bảng điều khiển Kho</h3>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <span class="oi oi-box"></span> Đơn hàng cần xử lý (Xuất kho)
            </div>
            <div class="card-body">
                @if (ordersToFulfill == null)
                {
                    <LoadingSpinner />
                }
                else if (!ordersToFulfill.Any())
                {
                    <div class="alert alert-success mt-3">Không có đơn hàng nào cần xử lý.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (var order in ordersToFulfill)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Đơn hàng #@order.Id - @order.CustomerName
                                <a href="@($"/admin/orders/{order.Id}")" class="btn btn-sm btn-info">Chuẩn bị hàng</a>
                            </li>
                        }
                    </ul>

                    @if (orderTotalPages > 1)
                    {
                        <nav class="mt-3" aria-label="Orders page navigation">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(orderCurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{Math.Max(orderCurrentPage - 1, 1)}/{poCurrentPage}/{rrCurrentPage}")">Trước</a>
                                </li>

                                @for (int i = 1; i <= orderTotalPages; i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(orderCurrentPage == pageNum ? "active" : "")">
                                        <a class="page-link" href="@($"/admin/warehouse/page/{pageNum}/{poCurrentPage}/{rrCurrentPage}")">@pageNum</a>
                                    </li>
                                }

                                <li class="page-item @(orderCurrentPage == orderTotalPages ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{Math.Min(orderCurrentPage + 1, orderTotalPages)}/{poCurrentPage}/{rrCurrentPage}")">Sau</a>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <span class="oi oi-clipboard"></span> Đơn nhập hàng đang chờ (Nhập kho)
            </div>
            <div class="card-body">
                @if (purchaseOrdersToReceive == null)
                {
                    <LoadingSpinner />
                }
                else if (!purchaseOrdersToReceive.Any())
                {
                     <div class="alert alert-info mt-3">Không có đơn nhập hàng nào đang chờ.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (var po in purchaseOrdersToReceive)
                        {
                             <li class="list-group-item d-flex justify-content-between align-items-center">
                                Phiếu nhập @po.PurchaseOrderNumber - @po.Supplier?.Name
                                <a href="@($"/admin/purchase-orders/{po.Id}")" class="btn btn-sm btn-secondary">Xem/Nhận hàng</a>
                            </li>
                        }
                    </ul>

                    @if (poTotalPages > 1)
                    {
                        <nav class="mt-3" aria-label="PO page navigation">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(poCurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{Math.Max(poCurrentPage - 1, 1)}/{rrCurrentPage}")">Trước</a>
                                </li>

                                @for (int i = 1; i <= poTotalPages; i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(poCurrentPage == pageNum ? "active" : "")">
                                        <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{pageNum}/{rrCurrentPage}")">@pageNum</a>
                                    </li>
                                }

                                <li class="page-item @(poCurrentPage == poTotalPages ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{Math.Min(poCurrentPage + 1, poTotalPages)}/{rrCurrentPage}")">Sau</a>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-danger text-white">
                <span class="oi oi-loop"></span> Phiếu thu hồi đang chờ (Thu hồi hàng)
            </div>
            <div class="card-body">
                @if (returnReceiptsToReceive == null)
                {
                    <LoadingSpinner />
                }
                else if (!returnReceiptsToReceive.Any())
                {
                    <div class="alert alert-info mt-3">Không có phiếu thu hồi nào đang chờ.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (var rr in returnReceiptsToReceive)
                        {
                            var hasMismatch = rr.Items != null && rr.Items.Any(i => i.ReceivedQuantity != i.Quantity);

                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">
                                        Phiếu thu hồi @rr.ReturnReceiptNumber
                                        <span class="text-muted small"> - Đơn #@(rr.RelatedOrderId ?? 0)</span>
                                    </div>

                                    <div class="mt-1">
                                        @if (hasMismatch)
                                        {
                                            <span class="badge bg-info text-dark me-2">Có chênh lệch</span>
                                        }
                                        <span class="badge @GetRrBadgeClass(rr.Status)">@rr.Status</span>
                                        <small class="text-muted ms-2"> @rr.CreatedAt.ToLocalTime().ToString("g")</small>
                                    </div>
                                </div>

                                <a href="@($"/admin/return-receipts/{rr.Id}")" class="btn btn-sm btn-secondary">Xem/Nhận hàng</a>
                            </li>
                        }
                    </ul>

                    @if (rrTotalPages > 1)
                    {
                        <nav class="mt-3" aria-label="RR page navigation">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(rrCurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{poCurrentPage}/{Math.Max(rrCurrentPage - 1, 1)}")">Trước</a>
                                </li>

                                @for (int i = 1; i <= rrTotalPages; i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(rrCurrentPage == pageNum ? "active" : "")">
                                        <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{poCurrentPage}/{pageNum}")">@pageNum</a>
                                    </li>
                                }

                                <li class="page-item @(rrCurrentPage == rrTotalPages ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{poCurrentPage}/{Math.Min(rrCurrentPage + 1, rrTotalPages)}")">Sau</a>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int OrderPage { get; set; } = 1;
    [Parameter] public int PoPage { get; set; } = 1;
    [Parameter] public int RrPage { get; set; } = 1;

    private List<Order>? ordersToFulfill;
    private List<PurchaseOrder>? purchaseOrdersToReceive;
    private List<ReturnReceipt>? returnReceiptsToReceive;

    private int orderCurrentPage = 1;
    private int orderPageSize = 5;
    private int orderTotalPages = 1;
    private int orderTotalItems = 0;

    private int poCurrentPage = 1;
    private int poPageSize = 5;
    private int poTotalPages = 1;
    private int poTotalItems = 0;

    private int rrCurrentPage = 1;
    private int rrPageSize = 5;
    private int rrTotalPages = 1;
    private int rrTotalItems = 0;

    protected override async Task OnParametersSetAsync()
    {
        // set current pages from route params
        orderCurrentPage = OrderPage > 0 ? OrderPage : 1;
        poCurrentPage = PoPage > 0 ? PoPage : 1;
        rrCurrentPage = RrPage > 0 ? RrPage : 1;

        await LoadOrdersPage(orderCurrentPage);
        await LoadPurchaseOrdersPage(poCurrentPage);
        await LoadReturnReceiptsPage(rrCurrentPage);
    }

    private async Task LoadOrdersPage(int page)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        var statusesForWarehouse = new[]
        {
            "Đã thanh toán",
            "Sẵn sàng giao hàng",
            "Chờ thanh toán",
            "Chờ xác nhận"
        };

        IQueryable<Order> baseQ = db.Orders
            .AsNoTracking()
            .Where(o => statusesForWarehouse.Contains(o.Status));

        orderTotalItems = await baseQ.CountAsync();
        orderTotalPages = Math.Max(1, (int)Math.Ceiling((double)orderTotalItems / orderPageSize));
        orderCurrentPage = Math.Clamp(page, 1, orderTotalPages);

        ordersToFulfill = await baseQ
            .OrderBy(o => o.OrderDate)
            .Skip((orderCurrentPage - 1) * orderPageSize)
            .Take(orderPageSize)
            .ToListAsync();
    }

    private async Task LoadPurchaseOrdersPage(int page)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        IQueryable<PurchaseOrder> baseQ = db.PurchaseOrders
            .AsNoTracking()
            .Include(po => po.Supplier)
            .Where(po => po.Status == "Đã đặt hàng");

        poTotalItems = await baseQ.CountAsync();
        poTotalPages = Math.Max(1, (int)Math.Ceiling((double)poTotalItems / poPageSize));
        poCurrentPage = Math.Clamp(page, 1, poTotalPages);

        purchaseOrdersToReceive = await baseQ
            .OrderBy(po => po.OrderDate)
            .Skip((poCurrentPage - 1) * poPageSize)
            .Take(poPageSize)
            .ToListAsync();
    }

    private async Task LoadReturnReceiptsPage(int page)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        IQueryable<ReturnReceipt> baseQ = db.ReturnReceipts
            .AsNoTracking()
            .Include(rr => rr.Items)
            .Where(rr => rr.Status == "Đã đặt hàng" || rr.Status == "Chờ phê duyệt")
            .OrderByDescending(rr => rr.CreatedAt);

        rrTotalItems = await baseQ.CountAsync();
        rrTotalPages = Math.Max(1, (int)Math.Ceiling((double)rrTotalItems / rrPageSize));
        rrCurrentPage = Math.Clamp(page, 1, rrTotalPages);

        returnReceiptsToReceive = await baseQ
            .Skip((rrCurrentPage - 1) * rrPageSize)
            .Take(rrPageSize)
            .ToListAsync();
    }

    private void ChangeOrderPage(int page)
    {
        page = Math.Clamp(page, 1, orderTotalPages);
        Navigation.NavigateTo($"/admin/warehouse/page/{page}/{poCurrentPage}/{rrCurrentPage}");
    }

    private void ChangePoPage(int page)
    {
        page = Math.Clamp(page, 1, poTotalPages);
        Navigation.NavigateTo($"/admin/warehouse/page/{orderCurrentPage}/{page}/{rrCurrentPage}");
    }

    private void ChangeRrPage(int page)
    {
        page = Math.Clamp(page, 1, rrTotalPages);
        Navigation.NavigateTo($"/admin/warehouse/page/{orderCurrentPage}/{poCurrentPage}/{page}");
    }

    private string GetRrBadgeClass(string? status)
    {
        if (string.IsNullOrEmpty(status)) return "bg-secondary";
        if (status.StartsWith("Đã nhận hàng")) return "bg-success";
        if (status.StartsWith("Bị từ chối")) return "bg-danger text-white";
        if (status == "Chờ phê duyệt") return "bg-info text-dark";
        if (status == "Đã đặt hàng") return "bg-warning text-dark";
        return "bg-secondary";
    }

    private async Task GoBack()
    {
        try
        {
            var handled = false;
            try
            {
                handled = await JS.InvokeAsync<bool>("appHelpers.goBackIfPossible");
            }
            catch
            {
                handled = false;
            }

            if (!handled)
            {
                Navigation.NavigateTo("/admin");
            }
        }
        catch
        {
            Navigation.NavigateTo("/admin");
        }
    }
}
